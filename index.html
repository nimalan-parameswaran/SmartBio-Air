<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYOSA Algae Bioreactor Dashboard</title>
    <!-- Chart.js for Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-primary: #e0e0e0;
            --accent-green: #00e676;
            --accent-blue: #2979ff;
            --accent-red: #ff1744;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }

        h1 { margin: 0; font-weight: 300; }
        .status-badge {
            background-color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card h3 {
            margin-top: 0;
            color: #aaa;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .metric {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
        }

        .unit { font-size: 0.4em; color: #888; }

        /* Status Colors */
        .good { color: var(--accent-green); }
        .bad { color: var(--accent-red); }
        .neutral { color: var(--accent-blue); }

        /* Charts */
        .chart-container {
            background-color: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            height: 400px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>MYOSA <span style="color:var(--accent-green)">AlgaeNet</span> Dashboard</h1>
        <div class="status-badge" id="connectionStatus">Connecting to Azure...</div>
    </header>

    <!-- Real-time Cards -->
    <div class="dashboard-grid">
        <div class="card">
            <h3>Air Quality (MQ-135)</h3>
            <div class="metric" id="mqMetric">--</div>
            <div id="mqStatus">Waiting...</div>
        </div>
        <div class="card">
            <h3>Algae Health Index</h3>
            <div class="metric" id="algaeMetric">--<span class="unit">%</span></div>
            <div id="algaeStatus">Optical Density</div>
        </div>
        <div class="card">
            <h3>Pump Motor Health</h3>
            <div class="metric" id="motorMetric">--</div>
            <div id="motorStatus">Vibration Analysis</div>
        </div>
        <div class="card">
            <h3>Environment</h3>
            <div class="metric" id="pressureMetric">--<span class="unit">Pa</span></div>
            <div>Barometric Pressure</div>
        </div>
    </div>

    <!-- Charts -->
    <div class="chart-container">
        <canvas id="mainChart"></canvas>
    </div>
</div>

<script>
    // --- CONFIGURATION ---

    const AZURE_API_URL = MY_API_KEY; 

    // --- CHART SETUP ---
    const ctx = document.getElementById('mainChart').getContext('2d');
    const mainChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Air Quality (MQ-135)',
                    data: [],
                    borderColor: '#ff1744',
                    yAxisID: 'y',
                    tension: 0.4
                },
                {
                    label: 'Algae Density (Green Light)',
                    data: [],
                    borderColor: '#00e676',
                    yAxisID: 'y1',
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            scales: {
                x: { ticks: { color: '#888' }, grid: { color: '#333' } },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: { display: true, text: 'Gas Level (PPM)' },
                    ticks: { color: '#888' },
                    grid: { color: '#333' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: { display: true, text: 'Optical Density' },
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#00e676' }
                }
            },
            plugins: {
                legend: { labels: { color: '#e0e0e0' } },
                title: { display: true, text: 'Agent 2 Research Data: AQ vs Algae Growth', color: '#e0e0e0' }
            }
        }
    });

    // --- DATA FETCHING ---
    async function fetchData() {
        const statusBadge = document.getElementById('connectionStatus');
        
        try {
            const response = await fetch(AZURE_API_URL);
            if (!response.ok) throw new Error("API Error");
            
            const data = await response.json();
            statusBadge.innerText = "● Live Agent Data";
            statusBadge.style.color = "#00e676";

            updateDashboard(data);
        } catch (error) {
            console.error(error);
            statusBadge.innerText = "● Offline / CORS Error";
            statusBadge.style.color = "#ff1744";
        }
    }

    function updateDashboard(history) {
        if (history.length === 0) return;

        // 1. Get latest reading
        const latest = history[history.length - 1];

        // 2. Update Metrics
        document.getElementById('mqMetric').innerText = latest.mq135;
        document.getElementById('mqMetric').className = latest.mq135 > 2000 ? "metric bad" : "metric good";
        
        document.getElementById('algaeMetric').innerText = latest.algae;
        
        // Motor Logic (0 = Good, 1 = Fault)
        const motorEl = document.getElementById('motorMetric');
        if (latest.motor_fault == 1) {
            motorEl.innerText = "FAULT";
            motorEl.className = "metric bad";
        } else {
            motorEl.innerText = "OK";
            motorEl.className = "metric good";
        }

        document.getElementById('pressureMetric').innerText = Math.round(latest.pressure);

        // 3. Update Chart
        // Convert timestamps to readable time
        const labels = history.map(d => {
            const date = new Date(parseFloat(d.timestamp) * 1000);
            return date.getHours() + ":" + date.getMinutes();
        });

        mainChart.data.labels = labels;
        mainChart.data.datasets[0].data = history.map(d => d.mq135);
        mainChart.data.datasets[1].data = history.map(d => d.algae);
        mainChart.update();
    }

    // Refresh every 10 seconds
    fetchData();
    setInterval(fetchData, 10000);

</script>
</body>
</html>
